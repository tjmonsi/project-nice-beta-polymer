<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../components/organisms/article.html">
<link rel="import" href="../../behaviors/article-behavior.html">
<link rel="import" href="../../behaviors/file-behavior.html">

<dom-module id="article-view">

  <template>

    <style is="custom-style" include="iron-flex iron-flex-alignment">
      .article-editor-form {
        padding: 20px;
        padding-top: 0px;
      }

      paper-spinner {
        width: 100px;
        height: 100px;
        --paper-spinner-stroke-width: 6px;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/:action"
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>

    <firebase-document
      id="data-ref"
      path="[[articlePath.articles]]/[[pageId]]"
      data="{{article}}">
    </firebase-document>
    <firebase-document
      id="owner-ref"
      path="[[articlePath.owners]]/[[pageId]]"
      data="{{owner}}">
    </firebase-document>
    <firebase-document
      id="published-ref"
      data="{{publishOption}}"
      path="[[articlePath.options.published]]/[[pageId]]">
    </firebase-document>
    <firebase-document
      id="draft-ref"
      data="{{draftOption}}"
      path="[[articlePath.options.draft]]/[[pageId]]">
    </firebase-document>
    <firebase-document
      id="front-ref"
      data="{{frontOption}}"
      path="[[articlePath.options.front]]/[[pageId]]">
    </firebase-document>
    <firebase-storage
      id="file-ref"
      path="[[articlePath.articles]]/[[pageId]]"
      data="{{fileUpload}}"
      uploadTask="{{uploadTask}}">
    </firebase-storage>

    <template is="dom-if" if="{{_forceZero(article)}}">
      <div class="layout horizontal wrap">
        <template is="dom-if" if="{{_checkAction(action)}}">
          <template is="dom-if" if="{{checkPermission(roles.staff, user, online, owner)}}">
            <div class="flex article-editor-form">
              <form is="iron-form" id="article-editor">
                <paper-input
                  id="title"
                  name="title"
                  label="Title"
                  value="{{article.title}}"
                  max="100"
                  char-counter
                  >
                </paper-input>
                <paper-input
                  name="header-image"
                  id="header-image"
                  label="Header Image"
                  value="{{article.header_image}}">
                </paper-input>
                <input
                  name="headerImageFileUpload"
                  placeholder="Upload it here"
                  type="file"
                  data-for="header-image"
                  on-change="uploadFile"
                  >
                </input>
                <hr/>
                <br/>
                <paper-textarea
                  id="sub-title"
                  label="Short Description"
                  name="sub-title"
                  value="{{article.sub_title}}"
                  rows="1"
                  max="200"
                  char-counter>
                </paper-textarea>
                <paper-textarea
                  id="body"
                  label="Body"
                  name="body"
                  value="{{article.body}}"
                  rows="5"
                  char-counter>
                </paper-textarea>
                <div class="horizontal layout" style="padding: 10px">
                  <span style="padding-right: 10px">
                    Publish:
                  </span>
                  <paper-toggle-button
                    id="publish"
                    on-change="onPublish"
                  ></paper-toggle-button>
                </div>
                <div class="horizontal layout" style="padding: 10px">
                  <span style="padding-right: 10px">
                    Front published:
                  </span>
                  <paper-toggle-button
                    id="front"
                    on-change="onFrontPublish"
                  ></paper-toggle-button>
                </div>

              </form>
            </div>

          </template>
        </template>

        <div class="flex" style="min-width: 400px">
          <article-organism
            article="[[article]]"
            roles="[[roles]]"
            page-id="[[pageId]]"
            action="[[action]]">
          </article-organism>
          <div class="">
            <template is="dom-if" if="{{checkPermission(roles.staff, user, online, owner)}}">
              <template is="dom-if" if="{{isEditorOpen}}">
                <a href="/article-page/[[pageId]]/view">
                  <paper-button>Close Editor</paper-button>
                </a>
              </template>
              <template is="dom-if" if="{{!isEditorOpen}}">
                <a href="/article-page/[[pageId]]/edit">
                  <paper-button>Open Editor</paper-button>
                </a>
              </template>
            </template>
          </div>
        </div>
      </div>
    </template>

    <template is="dom-if" if="{{!_forceZero(article)}}">
      <div class="horizontal layout">
        <div class="flex"></div>
        <div class="center flex" style="margin-top: 200px; text-align: center">
          <paper-spinner alt="Loading article" active></paper-spinner>
        </div>
        <div class="flex"></div>
      </div>
    </template>
    <paper-toast id="toaster"></paper-toast>
  </template>

  <script>

    Polymer({

      is: 'article-view',

      properties: {
        isEditorOpen: {
          type: Boolean,
          value: false,
          computed: '_checkAction(action)'
        }
      },

      observers: [
        '_routeActionChanged(routeData.action)',
        '_checkPublish(draftOption)',
        '_checkFront(frontOption)'
      ],

      _checkPublish(o) {
        if (this.$$('#publish')) {
          this.$$('#publish').checked = this._forceZero(o) ? false : true
        }
      },

      _checkFront(o) {
        if (this.$$('#front')) {
          this.$$('#front').checked = this._forceZero(o) ? true : false;
        }
      },

      onPublish(e) {
        var message = e.target.checked ? 'Published' : 'Not Published';
        var checked = e.target.checked;
        this._setOption(
          this.articlePath.options.draft,
          this.pageId,
          !checked ? this._todayUTC : null,
          '#draft-ref'
        ).then(function(){
          if (!checked) {
            this._setOption(
              this.articlePath.options.front,
              this.pageId,
              null,
              '#front-ref'
            ).catch(this._catchError.bind(this));
          }
          this._setOption(
            this.articlePath.options.published,
            this.pageId,
            checked ? this._todayUTC : null,
            '#published-ref'
          ).then(function(){
            e.target.checked = checked;
            this.$.toaster.hide();
            this.$.toaster.show(message);
          }.bind(this)).catch(this._catchError.bind(this));
        }.bind(this)).catch(this._catchError.bind(this));
      },

      onFrontPublish(e) {
        var message = e.target.checked ? 'Published at Header' : 'Removed at Header';
        var checked = e.target.checked;
        if (checked) {
          this._setOption(
            this.articlePath.options.published,
            this.pageId,
            null,
            '#draft-ref'
          ).catch(this._catchError.bind(this));
          this._setOption(
            this.articlePath.options.published,
            this.pageId,
            this._todayUTC,
            '#published-ref'
          ).catch(this._catchError.bind(this));
        }
        this._setOption(
          this.articlePath.options.front,
          this.pageId,
          checked ? this._todayUTC : null,
          '#front-ref'
        ).then(function(){
          e.target.checked = checked;
          this.$.toaster.hide();
          this.$.toaster.show(message);
        }.bind(this)).catch(this._catchError.bind(this));


      },

      behaviors: [
        Polymer.FileBehavior,
        Polymer.ArticleBehavior,
      ],

      _routeActionChanged(action) {
        console.log(action)
        this.action = action;
      },

      _checkAction(a) {
        console.log(a === 'edit');
        return a === 'edit';
      },

    });

  </script>

</dom-module>
