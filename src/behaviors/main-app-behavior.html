<link rel="import" href="../../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../data-state-handlers/js">
<script>
  (function(){
    'use strict';

    Polymer.MainAppBehaviorImpl = {

      properties: {
        route: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        },
        user: {
          type: Object,
          reflectToAttribute: true,
          value: null
        },
        isEditable: {
          type: Boolean,
          readOnly: true,
          reflectToAttribute: true,
          value: false,
          computed: '_checkEditable(user, online)'
        },
        isEditor: {
          type: Boolean,
          readOnly: true,
          reflectToAttribute: true,
          value: false,
          computed: '_checkEditor(user, online)'
        },
        userPath: {
          type: Object,
          readOnly: true,
          reflectToAttribute: true,
          value: function() { return this._userPath }
        },
        userGroup: {
          type: String,
          readOnly: true,
          reflectToAttribute: true,
          value: function() { return this._userGroup }
        },
        page: {
          type: String,
          notify: true,
          reflectToAttribute: true,
        },
        pageId: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          observer: '_checkIdExists'
        },
        action: {
          type: String,
          notify: true,
          reflectToAttribute: true,
        }
      },

      get _randomStringPool() {
        return 'abcdefghijklmnopqrstuvwxyz';
      },

      get _randomStringLength() {
        return 10;
      },

      get _todayUTCString() {
        return new Date().toUTCString();
      },

      get _userGroup() {
        return 'user_group';
      },

      get _userPath() {
        var options = `${this._userGroup}/roles`;
        return {
          profiles: `${this._userGroup}/profiles`,
          options: {
            admin: `${options}/admin`,
            editor: `${options}/editor`,
            staff: `${options}/staff`,
            member: `${options}/member`
          }
        };
      },

      _checkEditable(u, o) {
        // TODO: change to check if user is owner or a contributor
        return u && o;
      },

      _checkEditor(u, o) {
        // TODO: change to check if user is at least editor or admin
        return u && o;
      },

      _gotoPage(page, pageId = '', action, name = 'New Window') {
        var url = action && typeof action === 'string' ? `/${pageId}/${action}` :  `/${pageId}`;
        // window.location.href = url;
        if (window.history && window.history.pushState) {
          window.history.pushState({}, name, url);
          this.route = Object.assign({}, this.route, {
            prefix: '/article-page',
            path: url
          });
          this.importHref(
            this.resolveUrl(`/src/pages/${page}.html`), null, null, true);
        } else {
          window.location.href = this.route.prefix + url;
        }
      },

      _setOwner(group, id) {
        return new Promise(function(resolve, reject){
          if (group && typeof group === 'string' && id) {
            this.$$('#owner-ref').setStoredValue(`${group}/${id}`, this.user.uid).then(resolve).catch(reject);
          } else {
            this.$.toaster.show(`Cannot set owner for ${id ? id : 'new object'}`);
            reject(new Error('No id or group path for owner present'));
          }
        }.bind(this));
      },

      openCreateNewDialog() {
        if (this.$$('#create-new-dialog')) {
          this.$$('#create-new-dialog').open();
        } else {
          this.$.toaster.show('Error: No dialog box exists. Please report to us for this bug');
        }
      },

      insertNew(e) {
        if (this.isEditable) {
          if (!this.$$('#create-new-title').value || this.$$('#create-new-title').value.trim().length == 0) {
            this.$.toaster.show('Please put a title before creating');
            return;
          }
          var randomString = chance.string({length: this._randomStringLength ,pool: this._randomStringPool});
          var sluggedTitle = `${slug(this.$$('#create-new-title').value)}-slug--${slug(randomString)}`;
          this.$$('#create-new-fab').setAttribute('disabled', true);
          if (this.page === 'article-page') {
            this._insertNewArticle(sluggedTitle, e);
          }
        } else {
          this.$.toaster.show(`You are not authorized to create a new ${page.split('-').join(' ')}`);
        }
      },

      signIn() {
        this.$.auth.signInWithPopup().then(function(result) {
          this.$.toaster.show(`Welcome ${result.user.displayName}!`);
        }.bind(this)).catch(this._catchError.bind(this));
      },

      signOut() {
        if (this.$.auth) {
          this.$.auth.signOut().then(function() {
            this.$.toaster.show(`Goodbye!`);
          }.bind(this)).catch(this._catchError.bind(this));
        } else {
          this.$.toaster.show('You are already logged out.');
        }
      },

      _catchError(error) {
        console.log(error);
        this.$.toaster.show(`Error: ${error.message}`);
        if (this.$$('#create-new-fab')) {
          this.$$('#create-new-fab').removeAttribute('disabled');
        }
      },
    };
    Polymer.MainAppBehavior = [
      Polymer.AppNetworkStatusBehavior,
      Polymer.MainAppBehaviorImpl
    ];
  })();
</script>